<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hist√≥ricas Decoloniais</title>

<!-- ‚úÖ VLibras - CSS -->
<link rel="stylesheet" href="https://vlibras.gov.br/app/public/css/vlibras.css" />
<style>
#stopAllBtn {
  position: fixed;
  bottom: 16px;
  right: 16px;
  z-index: 1000;
  background: #c62828;
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
#stopAllBtn:hover {
  background: #b71c1c;
}
/* --- Estilos ajustados --- */
:root{ --base-font:100%; }
html { font-size: var(--base-font); }

.main-title {
  font-size: 2rem;
  font-weight: bold;
  color: #004080;
  text-align: center;
  margin-bottom: 1rem;
}

.subtitle {
  text-align: justify; /* ‚Üê justificado */
  font-size: 1.2rem;
  color: #4b2e2e;
  max-width: 800px;
  margin: 0 auto 1rem auto;
  line-height: 1.6;
  padding: 0 1rem;
}
:root { --bg:#fbf6f6; --card:#d8d0d0; --fg:#0b1220; --muted:#556; --accent:#a0522d; }
body{ font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 1rem; background: #dabbac; color: var(--fg); }
h1,h2{ text-align:center; }
.card{ background:var(--card); border-radius:12px; padding:1rem; margin:1rem auto; max-width:900px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

.selection-grid { 
    display: grid;
    grid-template-columns: auto 1fr; 
    gap: 8px 15px; 
    align-items: center;
    margin-bottom: 1rem;
}
.selection-grid label {
    text-align: left; 
    font-weight: bold;
}
.selection-grid select {
    width: 100%; 
}

select,button{ padding:0.5rem; margin:0.25rem 0; border-radius:6px; border:1px solid #6e6b6b; font-size:1rem; }
button { background-color: #a0522d; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; }
button:hover { background-color: #8b4513; }
button:disabled{ background:#ccc; color:#666; cursor:not-allowed; }
img{ max-width:100%; border-radius:8px; margin:0.5rem 0; }
.audio-btn{ margin-right:0.5rem; }
.compare-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; margin-top:1rem; }
.recording-status { margin: 10px 0; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; }
.recording-active { background-color: #ffebee; color: #c62828; border: 1px solid #c62828; }
.recording-saved { background-color: #e8f5e8; color: #2e7d32; border: 1px solid #2e7d32; }

.high-contrast { background:#000 !important; color:#fff !important; }
.high-contrast .card { background:#111 !important; color:#fff !important; border: 1px solid #fff; }
.high-contrast button { background:#fff !important; color:#000 !important; border:1px solid #000 !important; }

.controls-row { margin-top: 8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content: space-between; }
.small-btn { padding:6px 10px; font-size:0.9rem; border-radius:6px; background:#fff; color:#333; border:1px solid #999; cursor:pointer; }
.small-btn:focus { outline:3px solid #ffd600; }
button:focus, select:focus { outline:3px solid #ffd600; outline-offset:2px; }

#narrativeText {
    text-align: justify;
    line-height: 1.6;
}

.footer {
    text-align: center;
    margin-top: 30px;
    padding: 10px 0;
    font-size: 0.9rem;
    color: #4b2e2e;
}
.high-contrast .footer {
    color: #aaa;
}
.high-contrast .footer {
  color: #aaa;
}
.high-contrast .subtitle {
  color: #fff !important;
}

#pdfComparisonBtn {
    display: none;
    margin: 1rem auto;
    padding: 8px 16px;
    font-size: 0.95rem;
}
/* Bot√£o global de parar tudo */
#stopAllBtn {
  position: fixed;
  bottom: 16px;
  right: 16px;
  z-index: 1000;
  background: #c62828;
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
#stopAllBtn:hover {
  background: #b71c1c;
}
.high-contrast .subtitle {
  color: #fff !important;
}
</style>
</head>
<body>
<button id="stopAllBtn" title="Parar todas as m√≠dias e leituras">‚èπÔ∏è</button>

<h1 class="main-title">
  <span class="typing-text">Hist√≥rias em Vozes: Um Olhar Decolonial</span>
</h1>

<div style="text-align: center; margin: 1rem auto 1.5rem auto;">
  <button id="btnAudioDesc" class="small-btn" title="Ouvir audiodescri√ß√£o do texto">üîä Audiodescri√ß√£o</button>
</div>

<p class="subtitle">Agora vamos comparar as narrativas hist√≥ricas. Podemos dizer que a hist√≥ria dos livros sempre tem raz√£o em rela√ß√£o aos eventos hist√≥ricos?</p>
<p class="subtitle">Esta √© a pergunta central que nos guiar√° a partir de agora. Em vez de aceitar uma √∫nica vers√£o do passado, iniciaremos uma profunda <strong>compara√ß√£o de narrativas hist√≥ricas</strong>. Analisaremos a diferen√ßa entre a hist√≥ria <em>oficial</em> (como a do Cronista portugu√™s, geralmente presente nos registros tradicionais) e as <strong>perspectivas silenciadas</strong> (como as do Ind√≠gena e do Afrodescendente/ex-escravizado).</p>
<p class="subtitle">Nossa miss√£o √© questionar: <strong>quem narra e quem √© narrado?</strong></p>
<p class="subtitle">Para isso, adotaremos uma lente cr√≠tica, valorizando os princ√≠pios da <strong>Decolonialidade</strong> e da <strong>Hist√≥ria Vista Por Baixo</strong>. O passado n√£o √© um bloco monol√≠tico, mas um mosaico de experi√™ncias onde a voz dos subalternos (os povos origin√°rios, os negros, os pobres) √© fundamental para desafiar as vers√µes hegem√¥nicas.</p>
<p class="subtitle">Al√©m disso, como estamos imersos na era digital, <strong>deixe sua pr√≥pria perspectiva</strong> sobre o assunto. Tamb√©m vamos <strong>problematizar as imagens e representa√ß√µes geradas por Intelig√™ncia Artificial (IA)</strong>, questionando se elas reproduzem ou rompem com os estere√≥tipos hist√≥ricos e vis√µes euroc√™ntricas.</p>
<p class="subtitle"><strong>√â hora de desvendar os m√∫ltiplos significados de um evento hist√≥rico, assumindo que a verdade hist√≥rica √© sempre disputada e constru√≠da.</strong></p>

<div class="card" aria-label="Sele√ß√£o e narrativa">
  <fieldset>
    <legend>Selecione evento e narrador</legend>
    <div class="selection-grid">
      <label for="eventoSelect">Evento:</label>
      <select id="eventoSelect" aria-label="Selecionar evento"></select>
      <label for="narradorSelect">Narrador:</label>
      <select id="narradorSelect" aria-label="Selecionar narrador"></select>
      <label for="voiceSelect">Voz para a narrativa:</label>
      <select id="voiceSelect" aria-label="Selecionar voz para a narrativa"></select>
    </div>

    <div class="controls-row" role="toolbar" aria-label="Controles principais">
        <div style="display:flex; gap:8px;">
            <button id="showNarrative">Mostrar narrativa</button>
            <button id="resetView">Limpar</button>
            <button id="compareBtn">Comparar narrativas</button>
        </div>

      <div style="display:flex; gap:8px;">
          <button id="contrastToggle" class="small-btn" aria-pressed="false" title="Alternar alto contraste">Alto contraste</button>
          <button id="fontInc" class="small-btn" title="Aumentar fonte">A+</button>
          <button id="fontDec" class="small-btn" title="Diminuir fonte">A‚àí</button>
        </div>
    </div>
  </fieldset>

  <div id="narrativeArea">
    <h2>Narrativa - O grande evento</h2>
    <div id="narrativeText" tabindex="0">Selecione um evento, um narrador e uma voz, depois clique em "Mostrar narrativa".</div>
    <div id="eventImageContainer" aria-live="polite"></div>

    <div id="audioControls" class="controls-row" aria-label="Controles de √°udio">
      <button id="playAudio" class="audio-btn">‚ñ∂Ô∏è Reproduzir √Åudio</button>
      <button id="stopAudio" class="audio-btn">‚èπÔ∏è Parar √Åudio</button>
      <button id="playAD" class="audio-btn" disabled>üë®üèø‚Äçü¶Ø Audiodescri√ß√£o da imagem</button>
    </div>
    <div id="comparisonArea"></div>
      
</div>

<div class="card">
  <h2>Conte-nos seu ponto de vista da hist√≥ria</h2>
  <p>Chegou sua vez: Selecione um Evento. <strong>Ao parar a grava√ß√£o, o √°udio ser√° salvo automaticamente</strong> para o narrador <strong>"Estudante"</strong> no evento em quest√£o.</p>
  <div id="recordingStatus" class="recording-status"></div>
  <button id="recStart">üî¥ Iniciar Grava√ß√£o</button>
  <button id="recStop" disabled>‚èπÔ∏è Parar e Salvar</button>
  <button id="recPlay" disabled>‚èØÔ∏è Reproduzir Grava√ß√£o</button>
  <button id="recDelete" disabled>üóëÔ∏è Excluir Grava√ß√£o</button>
</div>

<footer class="footer">
  ¬© 2025 Aline Concei√ß√£o Brito ‚Äî Desenvolvido para fins pedag√≥gicos. Todos os direitos reservados.
</footer>

<!-- ‚úÖ VLibras - Script (deve ficar antes do </body>) -->
<script src="https://vlibras.gov.br/app/public/js/vlibras.js"></script>
<script>
  new window.VLibras.Widget('https://vlibras.gov.br/app');
</script>

<script>
// ===================== DADOS (MANTIDOS) ===================== /
// (Seu c√≥digo JavaScript permanece exatamente igual ao anterior ‚Äî n√£o foi alterado)

const audioMapping = {
  "Coloniza√ß√£o do Brasil (s√©culo XVI e XVII)": {
    "Cronista portugu√™s": "https://soundcloud.com/aline-brito-225256690/portugues-chegada-2/s-dCPg2UDkmtL?in=aline-brito-225256690/sets/escolar/s-LJ6nxpK4cQY&si=229f25582b844b16bf9280a544b66294&utm_source=clipboard&utm_medium=text&utm_campaign=social_sharing",
    "Ind√≠gena": "  https://github.com/allineBrito/faculdade/blob/main/audio/portugues1.mp3  ",
    "Africano escravizado": "audio/negros-chegada.wav",
  },
  "Per√≠odo das Revoltas Regenciais (1831 ‚Äì 1840)": {
    "Cronista portugu√™s": "https://github.com/allineBrito/estudos_projetos/blob/main/audio/portuges-chegada.mp3  ",
    "Ind√≠gena": "audio/revolta_indi.mp3",
    "Africano escravizado": "audio/revolta_afri.mp3",
  },
  "Guerra de Canudos (1893 ‚Äì 1897)": {
    "Cronista portugu√™s": "audio/revolta_port.mp3",
    "Ind√≠gena": "audio/revolta_indi.mp3",
    "Africano escravizado": "audio/revolta_afri.mp3",
  }
};

const imageMapping = {
  "Cronista portugu√™s": "https://exemplo.com/perfil_cronista.jpg  ",
  "Ind√≠gena": "https://exemplo.com/perfil_indigena.png  ",
  "Africano escravizado": "https://exemplo.com/perfil_africano.png  ",
  "Mulher negra": "https://exemplo.com/perfil_mulher_negra.jpg  ",
  "Estudante": "https://i.ibb.co/JWjH7SGV/Chat-GPT-Image-15-de-out-de-2025-17-33-45.png  ",
};

const eventImageMapping = {
  "Coloniza√ß√£o do Brasil (s√©culo XVI e XVII)": {
    "Cronista portugu√™s": " https://i.postimg.cc/4NBgrBf3/colonizacao-portu.png ",
    "Ind√≠gena": " https://i.postimg.cc/vTyydKxr/colonizzacao-neg.png ",
    "Africano escravizado": " https://i.postimg.cc/Wb2VWQvP/colonizacao.png",
    "Estudante": "https://i.ibb.co/JWjH7SGV/Chat-GPT-Image-15-de-out-de-2025-17-33-45.png  ",
  },
  
  "Per√≠odo das Revoltas Regenciais (1831 ‚Äì 1840)": {
    "Cronista portugu√™s": " https://i.postimg.cc/13wK8Y89/Designer.png ",
    "Ind√≠gena (Cabano)": " https://i.postimg.cc/sDtcDRDP/Designer-2.png ",
    "Mal√™": " https://i.postimg.cc/13wK8Y8P/Designer-3.png",
    "Estudante": "https://i.ibb.co/JWjH7SGV/Chat-GPT-Image-15-de-out-de-2025-17-33-45.png  " ,
  },
  
  "Guerra de Canudos (1893 ‚Äì 1897)": {
    "Cronista Republicano": " https://i.postimg.cc/Dwvqzy3s/craiyon-105509-As-tropas-imperiais-sob-o-comando-her-ico-de-generais-experientes-como-o-Duque-de-Ca.png",
    "Sertanejo (Ind√≠gena/Caboclo)": " https://i.postimg.cc/SN76qY3s/craiyon-110037-Em-Canudos-o-santo-Ant-nio-Conselheiro-n-o-falava-apenas-de-Deus-Pai-ele-falava-de-j.png",
    "Ex-Escravizado": " https://i.postimg.cc/mgLQr2WC/craiyon-110124-Canudos-nosso-quilombo-do-sert-o-a-prova-de-que-sabemos-nos-organizar-resistir-e-s.png",
    "Estudante": "https://i.ibb.co/JWjH7SGV/Chat-GPT-Image-15-de-out-de-2025-17-33-45.png  ",
  }
};

const data = {
  "Coloniza√ß√£o do Brasil (s√©culo XVI e XVII)": {
    narrativas: {
      "Cronista portugu√™s": "Escutem, leg√≠timos s√∫ditos do Reino de Portugal! O que vemos no Brasil n√£o √© s√≥ uma terra distante, mas um novo e grandioso pilar do nosso Imp√©rio. Desde a chegada de Cabral, cumprimos o dever de tomar posse e levar a luz da nossa civiliza√ß√£o a estas terras do Novo Mundo. Nossa miss√£o √© dupla: extrair riquezas e converter os gentios √† verdadeira f√©. Fizemos do litoral nordestino o maior produtor de a√ß√∫car do mundo, o nosso Ouro Branco, que enriquece a Europa e fortalece os cofres da Coroa. As capitanias heredit√°rias organizam nossos dom√≠nios, enquanto os padres jesu√≠tas cuidam das almas perdidas. O sistema colonial que criamos √© firme e ordenado: a monocultura, o Pacto Colonial e a ordem que garante que toda a abund√¢ncia, do a√ß√∫car, da madeira, dos animais e do tabaco beneficie Lisboa. Aqui nada se perde. Tudo serve para a gl√≥ria do Reino de Portugal e para a expans√£o da Cristandade.",
      "Ind√≠gena": "Quando o povo do mar chegou, nossa vida mudou para sempre. Eles vieram como invasores, n√£o como amigos. No come√ßo, sentimos curiosidade e trocamos pau-brasil por ferro. Mas logo entendemos a verdade: queriam nossas terras e nossos corpos. Para eles, a floresta era mercadoria. Para n√≥s, era m√£e, ca√ßa e mem√≥ria dos ancestrais. Tentaram nos escravizar em planta√ß√µes erguidas sobre nossas aldeias. Os padres de batina preta nos levaram para aldeamentos, dizendo que era para nos proteger, mas querem apagar nossa l√≠ngua e nossos rituais sagrados. Nos Chamaram de √≠ndios cativos e nos venderam como animais. As doen√ßas que trouxeram, como var√≠ola e sarampo mataram aldeias inteiras, mais do que suas armas. O som dos tambores ancestrais foi substitu√≠do pelos sinos das miss√µes. Ainda assim, resistimos. Lutamos pelos nossos chefes, pelo nosso povo e pela nossa liberdade. Nossa cultura e nossa l√≠ngua continuam vivas nas matas e nos cora√ß√µes. A hist√≥ria do Brasil √© tamb√©m a hist√≥ria da nossa resist√™ncia, que nunca acabou.",
      "Africano escravizado": "Nossa hist√≥ria n√£o come√ßou no Brasil, mas nas terras da √Åfrica, nos reinos do Congo, de Angola, da Costa da Mina. Fomos tirados de nossos povos √† for√ßa: iorub√°s, bantos, hau√ß√°s, cada um com sua l√≠ngua e seus deuses. O que os portugueses chamam de com√©rcio, n√≥s chamamos de Grande Roubo. Fomos levados em navios apertados, onde a fome e as doen√ßas matavam muito antes de chegar aqui. No Brasil, n√£o √©ramos vistos como pessoas, mas como pe√ßas. Nosso corpo pertencia ao senhor, e nosso tempo era marcado pelo sol e pelo chicote. Nas planta√ß√µes e engenhos, o trabalho era pesado e a viol√™ncia, constante. Nossa vida valeria menos que o a√ß√∫car que produz√≠amos. Mas nunca aceitamos o cativeiro. Constru√≠mos quilombos como Palmares, onde Zumbi demonstrou que a liberdade era poss√≠vel. Guardamos nossas culturas, nossos tambores, nossos orix√°s e nossa f√©. Criamos o jongo, a capoeira, mantivemos vivos os terreiros. O Brasil colonial foi feito de dor e escravid√£o, mas tamb√©m de luta e coragem. Nossa resist√™ncia nunca foi vencida, e nossa heran√ßa est√° em cada batida do cora√ß√£o brasileiro.",
      "Estudante": ""
    },
    ad: {
            "Cronista portugu√™s": "Foto gerada por IA: A cena mostra um militar do Imp√©rio do Brasil em posi√ß√£o de destaque. Ele veste uniforme azul-escuro com detalhes dourados, ombreiras ornamentadas e medalhas no peito. Seu semblante √© s√©rio, com bigode espesso e olhar fixo √† frente. Na m√£o direita, segura uma espada apontada para cima, em sinal de comando. Ao fundo, a bandeira do Brasil imperial tremula entre soldados em combate, cercados por fuma√ßa de batalha. √Ä direita, h√° um edif√≠cio cl√°ssico em chamas, indicando destrui√ß√£o. O cen√°rio sugere o contexto das guerras do per√≠odo imperial, como a Guerra do Paraguai, e representa o poder e a autoridade militar do Estado brasileiro.",
      "Ind√≠gena": " Foto gerada por IA: A imagem retrata um grupo de ind√≠genas armados e prontos para o combate. No centro, um homem de express√£o firme segura um mosquete com as duas m√£os, vestindo camisa bege, chap√©u de palha e len√ßo vermelho no pesco√ßo. √Ä sua volta, outros ind√≠genas empunham lan√ßas e fac√µes, gritando em tom de guerra. Um deles, √† direita, ergue o bra√ßo com a arma e o rosto pintado, gritando com for√ßa. √Ä esquerda, uma mulher segura uma lan√ßa e encara o observador com olhar decidido. Em primeiro plano, um ind√≠gena de olhos fechados parece rezar, com as m√£os unidas em prece. Ao fundo, montanhas e uma vegeta√ß√£o verde indicam o ambiente natural. A cena representa a resist√™ncia dos povos ind√≠genas contra a invas√£o e a viol√™ncia colonial.",
      "Africano escravizado": " Foto gerada por IA:  A pintura mostra um grupo de pessoas negras em um momento de insurrei√ß√£o. No centro, um homem de pele escura, barba cheia e olhar intenso levanta um fac√£o com a m√£o direita, enquanto a esquerda repousa sobre o peito. Ele veste uma t√∫nica clara e uma faixa vermelha na cintura. Atr√°s dele, v√°rias pessoas gritam e erguem punhos e lan√ßas, expressando revolta e coragem. √Ä direita, um homem idoso segura um bast√£o e observa, com semblante grave. Ao fundo, sob o c√©u escuro pontilhado de estrelas, h√° uma igreja branca iluminada por fogo, sugerindo uma cena noturna de rebeli√£o. A imagem simboliza a luta dos negros escravizados por liberdade e dignidade no Brasil colonial.",
      "Estudante": "Audiodescri√ß√£o aluno."
    }
  },

  "Per√≠odo das Revoltas Regenciais (1831 ‚Äì 1840)": {
    narrativas: {
      "Cronista portugu√™s": "A ordem do Imp√©rio est√° amea√ßada e a unidade do pa√≠s corre perigo mortal! A abdica√ß√£o inesperada de D. Pedro I em 1831 e a menoridade do jovem Pedro II deixaram um vazio de poder que os inimigos da civiliza√ß√£o aproveitaram como abutres sobre carni√ßa. Fac√ß√µes rebeldes, republicanos traidores e a esc√≥ria da sociedade se levantaram contra tudo que constru√≠mos em tr√™s s√©culos de trabalho √°rduo. Somos os guardi√µes da civiliza√ß√£o crist√£ que Portugal trouxe a estas terras selvagens, e nossa miss√£o sagrada √© preservar os valores da Santa Igreja, a posi√ß√£o social que Deus distribuiu e a unidade nacional que nos torna respeitados entre as na√ß√µes. Nosso dever √© manter o Brasil unido, pr√≥spero e ordenado sob as leis do Imp√©rio e da Provid√™ncia Divina. As revoltas sangrentas que explodem por todo territ√≥rio, a Cabanagem selvagem do Par√°, onde caboclos e √≠ndios massacram fam√≠lias inteiras; uma sabinada separatista na Bahia; a Balaiada no Maranh√£o com seus vaqueiros desordeiros; e a trai√ßoeira Farroupilha no Sul n√£o s√£o movimentos por justi√ßa, mas explos√µes de barb√°rie, ambi√ß√£o pol√≠tica e inveja contra os bem-nascidos. S√£o hordas de desocupados, √≠ndios ignorantes, caboclos revoltosos, africanos sediciosos e republicanos sem p√°tria que, em sua cegueira e sede de destrui√ß√£o, atacam os pilares da nossa economia, da nossa f√© e da nossa ordem social. Querem transformar o Brasil numa rep√∫blica de selvagens! As tropas imperiais, sob o comando her√≥ico de generais experientes como o Duque de Caxias,  o Pacificador, agir√£o com punho de ferro para esmagar essas sedi√ß√µes diab√≥licas, restaurar a paz crist√£ e mostrar √†s na√ß√µes civilizadas da Europa que o Brasil sabe se governar com dignidade. Quem amea√ßar a unidade nacional ser√° tratado como traidor da p√°tria, da Coroa e da pr√≥pria civiliza√ß√£o!.",
      "Ind√≠gena (Cabano)": "Nos chamam de cabanos, selvagens, assassinos e desordeiros, mas somos os verdadeiros filhos desta terra! Nossos antepassados navegaram os rios sagrados do Par√°, pescaram nessas √°guas e ca√ßaram nessas florestas muito antes dos portugueses chegarem com suas caravelas carregadas de gan√¢ncia. Por gera√ß√µes, vimos os bar√µes do a√ß√∫car, os comerciantes portugueses gordos e os fazendeiros de gado roubarem nossas terras ancestrais enquanto vivem como reis nas cidades grandes como Bel√©m, comendo do bom e do melhor enquanto nossos filhos passam fome na beira dos rios. Quando D. Pedro I fugiu como covarde para Portugal em 1831, nossos cora√ß√µes se encheram de esperan√ßa achamos que finalmente ser√≠amos ouvidos, que nossa voz ecoaria pelos igarap√©s at√© chegar ao governo. Mas nada mudou para quem vive na pobreza √† beira do Amazonas e seus afluentes! A escravid√£o continua, a humilha√ß√£o dos mamelucos e caboclos piora a cada dia, e o roubo do nosso sustento aumenta sem parar. Os impostos pesam sobre os nossos ombros como pedras enormes, enquanto os ricos portugueses n√£o pagam nem um vint√©m! Vemos nossos irm√£os morrerem de doen√ßas que os brancos trouxeram, nossas mulheres sendo desonradas pelos senhores, nossos filhos trabalharem como escravos nas fazendas dos outros. Foi ent√£o que pegamos em armas por fome, por justi√ßa e por dignidade! Seguimos l√≠deres corajosos como Eduardo Angelim, um dos nossos , os bravos irm√£os Vinagre, e tantos outros que preferem morrer de p√© a viver de joelhos. Queremos governar o Par√° com nossas pr√≥prias m√£os, que a terra perten√ßa a quem a trabalha com o suor do rosto, e que os tiranos que exploram nosso sangue sejam expulsos para sempre estas √°guas sagradas! Lutamos para sobreviver, para que nossos filhos n√£o sejam escravos em sua pr√≥pria terra! A for√ßa da floresta, dos rios caudalosos, dos ventos que sopram das montanhas e dos esp√≠ritos de nossos ancestrais guerreiros est√° conosco. Nosso grito de guerra por um governo justo ecoa pelas √°guas do Amazonas e √© mais forte que todas as balas do Imp√©rio! Preferimos morrer livres na nossa terra do que viver escravos na terra dos outros!.",
      "Mal√™": "Nos arrancaram das terras sagradas da √Åfrica  em navios negreiros fedorentos, mas jamais conseguiram roubar nossa f√© inabal√°vel em Al√°, nosso conhecimento das escrituras sagradas em √°rabe, nem a dignidade que carregamos no peito! Somos os Mal√™s de Salvador, nag√¥s orgulhosos, hau√ß√°s seguros, jejes guerreiros, todos unidos pela cren√ßa no Deus √∫nico e pelo sonho ardente da liberdade que nos foi prometida pelo Profeta. Nas senzalas escuras, ensinamos uns aos outros a ler o Cor√£o, a fazer as ora√ß√µes na dire√ß√£o de Meca, a manter viva a chama de nossa cultura ancestral. Vimos a fraqueza do governo regencial ap√≥s a fuga de D. Pedro I, vimos os brancos brigando entre si como c√£es raivosos, e aprendemos no fundo da alma que era a hora de Al√° nos havia escolhido para agir! Nas mesquitas escondidas nos por√µes, nos terreiros secretos, nos engenhos malditos do Rec√¥ncavo e nas ruas estreitas de Salvador, n√≥s nos organizamos em segredo absoluto durante meses. Conhec√≠amos a disciplina f√©rrea das cinco ora√ß√µes di√°rias, o poder sagrado das escritas √°rabes que nossos mestres nos ensinaram, e a for√ßa invenc√≠vel da uni√£o entre irm√£os de f√© que unem o mesmo sofrimento. Planejamos cada detalhe: onde atacar primeiro, como libertar os irm√£os das senzalas, como tomar os arsenais, como proclamar nossa liberdade. Na madrugada aben√ßoada de 25 de janeiro de 1835, quando as estrelas ainda brilhavam no c√©u de Salvador, nos levantamos como le√µes! Nossos cora√ß√µes batiam como tambores de guerra, nossas vozes gritavam ‚ÄúAl√° √© grande!‚Äù enquanto corremos pelas ruas com fac√µes, lan√ßamos a coragem de que s√≥ quem n√£o tem mais nada a perder pode ter. Lut√°vamos pela liberdade do corpo que nos acorrentaram e da alma que tentaram quebrar, pela dignidade que nos roubaram quando nos marcaram com ferro em brasa, pelo direito de sermos homens livres na terra que regamos com nosso suor e l√°grimas. Mas fomos tra√≠dos por alguns covardes que temiam a f√∫ria dos brancos, e a viol√™ncia dos soldados imperiais foi mais terr√≠vel que o inferno: nos prenderam como animais, nossos chicotearam at√© a carne aberta, executaram nossos l√≠deres mais corajosos e nos deportaram de volta para a √Åfrica como se f√¥ssemos transportados. Nossa revolta ecoou por todo o Imp√©rio e plantou sementes de liberdade que um dia florescer√£o.",
      "Estudante": ""
    },
    ad: {
      "Cronista portugu√™s": "Foto gerada por IA: A imagem mostra um grupo de pessoas ind√≠genas sentadas no ch√£o, cercadas por dois religiosos e um homem europeu armado. Os ind√≠genas est√£o com express√µes s√©rias, alguns olham para o ch√£o, outros observam os europeus. √Ä esquerda, um homem vestido com armadura de metal e capa vermelha fala com o dedo apontado, como quem d√° ordens. Atr√°s dele, um religioso segura uma cruz de madeira, e outro l√™ um livro aberto, provavelmente a B√≠blia. Ao fundo, h√° uma pequena igreja branca, com montanhas e vegeta√ß√£o tropical. A cena representa o momento da catequiza√ß√£o e imposi√ß√£o da f√© crist√£ sobre os povos ind√≠genas durante a coloniza√ß√£o.",
      "Ind√≠gena (Cabano)": " Foto gerada por IA: Nesta imagem, h√° v√°rias pessoas ind√≠genas adoecidas, com o corpo coberto de feridas vermelhas. Um homem est√° de joelhos, com um pesado colar de ferro e corrente no pesco√ßo. Outros ind√≠genas, inclusive idosos e crian√ßas, aparecem abatidos, com o rosto triste e o olhar baixo. Ao fundo, colonizadores europeus observam, alguns segurando correntes, e h√° um soldado com armadura. A paisagem tem uma cabana de palha e √°rvores. A imagem expressa o sofrimento causado pelas doen√ßas trazidas pelos colonizadores e pela escravid√£o imposta aos povos origin√°rios.",
      "Mal√™": " Foto gerada por IA: A cena ocorre no interior escuro de um navio negreiro. Diversas pessoas negras est√£o acorrentadas, sentadas ou deitadas, com express√µes de dor, cansa√ßo e resigna√ß√£o. No centro, um homem de p√©, com o corpo ereto e o olhar firme, tem uma corrente grossa em volta do pesco√ßo. Ao seu redor, outros homens e mulheres est√£o exaustos, alguns dormindo, outros com os olhos fechados. No fundo, um homem branco, de chap√©u, observa a cena com os bra√ßos cruzados. A atmosfera √© opressiva e triste, retratando o tr√°fico e a escraviza√ß√£o de africanos trazidos √† for√ßa para as Am√©ricas.",
      "Estudante": "Audiodescri√ß√£o aluno."
    }
  },

  "Guerra de Canudos (1893 ‚Äì 1897)": {
    narrativas: {
      "Cronista Republicano": "A Rep√∫blica est√° em perigo! O movimento fan√°tico de Canudos representa tudo o que combatemos: o atraso, a supersti√ß√£o e a barb√°rie que impedem o Brasil de se tornar uma na√ß√£o civilizada como a da Europa! Esse tal Ant√¥nio Conselheiro - um louco delirante que se diz profeta reuniu no sert√£o da Bahia uma horda de miser√°veis, jagun√ßos, ex-escravos e √≠ndios ignorantes. Eles desafiam abertamente as leis da Rep√∫blica, recusam pagar impostos, n√£o liberam o casamento civil e vivem como selvagens primitivos em pleno s√©culo XIX! N√£o podemos permitir que tal foco de rebeldia mon√°rquica e supersti√ß√£o religiosa prospere em territ√≥rio nacional! O dever sagrado do Ex√©rcito brasileiro √© restaurar a ordem republicana, impor a lei do progresso e exterminar essa amea√ßa √† civiliza√ß√£o. Quatro expedi√ß√µes militares foram permitidas para acabar com essa chaga no cora√ß√£o do Brasil. A destrui√ß√£o total de Canudos foi um ato de patriotismo! S√≥ assim a modernidade, a ci√™ncia e o progresso poder√£o florescer no sert√£o b√°rbaro. A Rep√∫blica n√£o tolera fanatismo nem desordem!.",
        "Sertanejo (Ind√≠gena/Caboclo)": "Irm√£os do sert√£o, escutem nossa dor! N√≥s, os verdadeiros filhos desta terra seca e aben√ßoada, j√° sofremos demais nas m√£os dos homens de fora que s√≥ trazem explora√ß√£o e morte. A seca nos castiga h√° anos  o sol queima nossa pele, o gado morre de sede, as crian√ßas choram de fome,mas a gan√¢ncia dos coron√©is latifundi√°rios √© pior que qualquer praga do c√©u! Eles roubam nossa √°gua, cercam nossas terras ancestrais e nos obrigam a trabalhar como escravos em suas fazendas malditas. Em Canudos, o santo Ant√¥nio Conselheiro n√£o falava apenas de Deus Pai ele falava de justi√ßa na terra, de um lugar sagrado onde n√£o ser√≠amos mais obrigados a beijar a m√£o suja de quem nos explora! L√°, todos eram iguais: √≠ndio, negro, branco, mulher, homem todos filhos do mesmo Deus! A Rep√∫blica dos doutores da cidade grande n√£o mudou nada para o sertanejo pobre - pelo contr√°rio, trouxe impostos pesados, casamento obrigat√≥rio no cart√≥rio e a obriga√ß√£o de servir aos mesmos coron√©is de sempre! O massacre de Canudos n√£o foi contra ‚Äòdesordem‚Äô - foi para sufocar nossa √∫nica chance de viver livres e com dignidade em nosso pr√≥prio ch√£o, longe da humilha√ß√£o e da mis√©ria imposta pelos poderosos! Eles mataram nossos irm√£os, queimaram nossas casas, mas n√£o mataram nossa esperan√ßa!.",
      "Ex-Escravizado": "Irm√£os de sofrimento, cinco anos depois da Lei √Åurea, a liberdade foi s√≥ no papel! Para muitos de n√≥s, a escravid√£o s√≥ mudou de nome  continuamos sem terra, sem trabalho, sem dignidade, empurrados para os mesmos latif√∫ndios onde nossos pais morreram no tronco. Canudos foi nosso farol no sert√£o escuro! O Conselheiro falava de um reino de Deus na Terra onde os √∫ltimos seriam os primeiros, onde o negro valeria tanto quanto o branco, onde n√£o haveria chicote nem senzala! Isso ecoava a esperan√ßa que nunca morre no peito de quem carrega a mem√≥ria do cativeiro. L√° no Belo Monte, √©ramos todos iguais na f√© e na luta di√°ria - sem a marca maldita da cor da pele ou da lembran√ßa da senzala. Trabalh√°vamos juntos, or√°vamos juntos, resist√≠amos juntos contra a opress√£o dos poderosos! A matan√ßa do Ex√©rcito republicano n√£o foi ‚Äòprogresso‚Äô - foi a repeti√ß√£o da mesma viol√™ncia que sempre tentou calar nossa voz de protesto! Eles destru√≠ram o arraial sagrado, degolaram nossos irm√£os, queimaram nossas crian√ßas, mas a cren√ßa na terra sem males, na resist√™ncia eterna contra o opressor, √© semente que fogo e bala jamais poder√£o apagar! Canudos √© nosso quilombo do sert√£o a prova de que sabemos nos organizar, resistir e sonhar com um mundo melhor! A luta continua!.",
      "Estudante": ""
    },
    ad: {
      "Cronista Republicano": "Foto gerada por IA: A imagem retrata um grupo de soldados uniformizados, marchando sob um c√©u sombrio cortado por feixes de luz. No centro, um homem de express√£o firme e olhar determinado lidera o grupo. As roupas s√£o formais, com detalhes dourados e vermelhos, lembrando uniformes de oficiais do ex√©rcito do s√©culo XIX. Atr√°s deles, bandeiras tremulam, sugerindo um momento de conquista ou avan√ßo militar.",
      "Sertanejo (Ind√≠gena/Caboclo)": " Foto gerada por IA: A imagem mostra um homem idoso, de longos cabelos e barba grisalha, de p√© sobre um pequeno monte de terra, com os bra√ßos abertos diante de uma multid√£o. Ele veste uma t√∫nica escura e parece falar com intensidade, sob o sol alaranjado do sert√£o. Ao fundo, casas simples e o horizonte seco refor√ßam o clima √°rido. A express√£o do homem √© s√©ria e inspirada, como se guiado por uma causa espiritual e social.",
      "Ex-Escravizado": " A cena mostra um vilarejo simples sob a luz dourada do amanhecer. As casas de barro e madeira se espalham entre a poeira do sert√£o. No c√©u, surgem, como vis√µes, enormes rostos de homens negros, olhando para o horizonte ‚Äî figuras simb√≥licas que representam a for√ßa, a ancestralidade e a esperan√ßa da comunidade de Canudos. No ch√£o, pessoas caminham, carregando objetos, construindo e vivendo o cotidiano do povoado.",
      "Estudante": "Audiodescri√ß√£o aluno."
    }
  }
};

const voiceMapping = {
  "Cronista portugu√™s": "Google portugu√™s do Brasil",
  "Sertanejo (Ind√≠gena/Caboclo)": "Microsoft Maria - Portuguese (Brazil)",
  "Ex-Escravizado": "Microsoft Daniel - Portuguese (Brazil)"
};

// ===================== elementos DOM ===================== /

const eventoSelect=document.getElementById('eventoSelect');
const narradorSelect=document.getElementById('narradorSelect');
const voiceSelect=document.getElementById('voiceSelect'); 
const narrativeText=document.getElementById('narrativeText');
const eventImageContainer=document.getElementById('eventImageContainer');
const playAudioBtn=document.getElementById('playAudio');
const stopAudioBtn=document.getElementById('stopAudio');
const playADBtn=document.getElementById('playAD');
const compareBtn=document.getElementById('compareBtn');
const comparisonArea=document.getElementById('comparisonArea');
const resetViewBtn=document.getElementById('resetView');

const contrastToggle = document.getElementById('contrastToggle');
const fontInc = document.getElementById('fontInc');
const fontDec = document.getElementById('fontDec');

const recStartBtn = document.getElementById('recStart');
const recStopBtn = document.getElementById('recStop');
const recPlayBtn = document.getElementById('recPlay');
const recDeleteBtn = document.getElementById('recDelete');
const recordingStatus = document.getElementById('recordingStatus');

// Bot√£o de audiodescri√ß√£o ‚Äî agora l√™ todo o texto introdut√≥rio
let introUtterance = null;
const btnAudioDesc = document.getElementById("btnAudioDesc");

btnAudioDesc.addEventListener("click", function () {
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
    this.innerHTML = "üîä Audiodescri√ß√£o";
    this.title = "Ouvir ou parar audiodescri√ß√£o do texto";
  } else {
    const mainTitle = document.querySelector(".main-title .typing-text")?.textContent || "";
    const subtitles = Array.from(document.querySelectorAll(".subtitle"))
      .map(p => p.textContent.trim())
      .filter(t => t)
      .join(" ");
    const fullIntroText = [mainTitle, subtitles].filter(Boolean).join(". ");

    if (!fullIntroText) {
      alert("Nenhum texto para ler.");
      return;
    }

    introUtterance = new SpeechSynthesisUtterance(fullIntroText);
    introUtterance.lang = "pt-BR";
    introUtterance.rate = 1;

    introUtterance.onstart = () => {
      this.innerHTML = "‚èπÔ∏è Parar Leitura";
      this.title = "Parar a leitura em andamento";
    };
    introUtterance.onend = introUtterance.onerror = () => {
      this.innerHTML = "üîä Audiodescri√ß√£o";
      this.title = "Ouvir ou parar audiodescri√ß√£o do texto";
    };

    speechSynthesis.speak(introUtterance);
  }
});
function createPDFButton() {
  const btn = document.createElement('button');
  btn.id = 'pdfComparisonBtn';
  btn.className = 'small-btn';
  btn.textContent = 'üñ®Ô∏è Imprimir PDF dos comparativos';
  btn.title = 'Imprimir compara√ß√£o em PDF';
  btn.style.display = 'block';
  btn.addEventListener('click', () => {
    const content = document.getElementById("comparisonArea").innerHTML;
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Compara√ß√£o de Narrativas</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}</style></head><body>');
    printWindow.document.write(content);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  });
  return btn;
}

// ===================== preencher selects ===================== /
Object.keys(data).forEach(ev=>{
  let opt=document.createElement('option'); opt.value=ev; opt.textContent=ev;
  eventoSelect.appendChild(opt);
});
function populateNarrators(){
  narradorSelect.innerHTML='';
  if(eventoSelect.value && data[eventoSelect.value]){
    Object.keys(data[eventoSelect.value].narrativas).forEach(n=>{
      let o=document.createElement('option'); o.value=n; o.textContent=n;
      narradorSelect.appendChild(o);
    });
    updateVoiceSelection(); 
  }
}
eventoSelect.addEventListener('change', populateNarrators);
narradorSelect.addEventListener('change', updateVoiceSelection); 
populateNarrators();

// ===================== CONTRASTE e FONTE ===================== /
contrastToggle.addEventListener('click', ()=> {
  const pressed = contrastToggle.getAttribute('aria-pressed') === 'true';
  contrastToggle.setAttribute('aria-pressed', String(!pressed));
  document.body.classList.toggle('high-contrast');
  contrastToggle.focus();
});
let baseFont = 100;
fontInc.addEventListener('click', ()=> { baseFont = Math.min(160, baseFont + 10); document.documentElement.style.setProperty('--base-font', baseFont + '%'); fontInc.focus(); });
fontDec.addEventListener('click', ()=> { baseFont = Math.max(70, baseFont - 10); document.documentElement.style.setProperty('--base-font', baseFont + '%'); fontDec.focus(); });

// ===================== Mostrar narrativa ===================== /
resetViewBtn.addEventListener('click', ()=>{
  eventoSelect.selectedIndex=0; narradorSelect.innerHTML=''; narrativeText.textContent='Selecione um evento e um narrador, depois clique em "Mostrar narrativa".';
  eventImageContainer.innerHTML=''; playADBtn.disabled=true; comparisonArea.innerHTML=''; updateRecordingStatus('');
  populateNarrators(); 
});
document.getElementById('showNarrative').addEventListener('click', ()=>{
  const ev=eventoSelect.value, nar=narradorSelect.value;
  if(!ev || !nar) return;
  if (nar === "Estudante" && hasRecordingForCurrentEvent()) {
    narrativeText.textContent = "üé§ Narrativa em √°udio dispon√≠vel - clique em 'Reproduzir Grava√ß√£o' para ouvir.";
  } else {
    narrativeText.textContent = data[ev].narrativas[nar] || '';
  }
  const eventImgSrc = eventImageMapping[ev] ? eventImageMapping[ev][nar] : '';
  let imageToShow = eventImgSrc || imageMapping[nar] || '';
  let altText = imageToShow ? `Imagem do evento ${ev} na perspectiva de ${nar}` : '';
  eventImageContainer.innerHTML = imageToShow ? `<img src="${imageToShow}" alt="${altText}">` : '';
  playADBtn.disabled = !data[ev].ad[nar];
  playADBtn.onclick = ()=> speakText(data[ev].ad[nar] || '', "pt-BR", nar);
});

// ===================== comparar ===================== /
compareBtn.addEventListener('click', ()=>{
  const ev=eventoSelect.value; if(!ev) return;
  const narrativas=data[ev].narrativas; const ads=data[ev].ad;
  comparisonArea.innerHTML = "";
  const oldPDFBtn = document.getElementById('pdfComparisonBtn');
  if (oldPDFBtn) oldPDFBtn.remove();
  const pdfBtn = createPDFButton();
  comparisonArea.parentNode.insertBefore(pdfBtn, comparisonArea);
  const container=document.createElement('div'); container.className="compare-grid";
  Object.keys(narrativas).forEach(n=>{
    const div=document.createElement('div'); div.className='card';
    const compareImgSrc = eventImageMapping[ev] && eventImageMapping[ev][n] ? eventImageMapping[ev][n] : imageMapping[n];
    const altText = `Imagem do evento ${ev} na perspectiva de ${n}`;
    let textoNarrativa = narrativas[n] || '';
    if (n === "Estudante" && hasRecordingForCurrentEvent()) textoNarrativa = "üé§ Narrativa em √°udio (grava√ß√£o do estudante)";
    div.innerHTML = `
      <h3>${n}</h3>
      <p style="text-align: justify; line-height: 1.6;">${textoNarrativa}</p>
      ${compareImgSrc ? `<img src="${compareImgSrc}" alt="${altText}">` : ''}
      <div style="margin-top:8px;">
        <button class="small-btn" data-narr="${encodeURIComponent(n)}">‚ñ∂Ô∏è √Åudio</button>
        <button class="small-btn" data-ad="${encodeURIComponent(ads[n]||'')}">‚ôø Audiodescri√ß√£o da </button>
      </div>
    `;
    container.appendChild(div);
  });
  comparisonArea.appendChild(container);
  comparisonArea.querySelectorAll('button.small-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const narr = decodeURIComponent(btn.getAttribute('data-narr')||'');
      const ad = decodeURIComponent(btn.getAttribute('data-ad')||'');
      if (btn.textContent.includes('√Åudio')) {
        speakText(data[eventoSelect.value].narrativas[narr] || '', "pt-BR", narr); 
      } else {
        speakText(ad || '', "pt-BR", 'Narrador'); 
      }
    });
  });
  pdfBtn.style.display = 'block';
});

// ===================== TTS ===================== /
let voices = [];
function loadVoices(){ 
  voices = speechSynthesis.getVoices() || []; 
  populateVoiceSelect(); 
  if(voices.length === 0) setTimeout(populateVoiceSelect, 500);
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function populateVoiceSelect() {
  if (voices.length === 0) {
    voiceSelect.innerHTML = '<option value="">&nbsp;(Carregando vozes...)</option>';
    return;
  }
  voiceSelect.innerHTML = '<option value="">&nbsp;(Autom√°tico)</option>';
  const voicesByLang = voices.reduce((acc, voice) => {
    const lang = voice.lang || 'Desconhecido';
    if (!acc[lang]) acc[lang] = [];
    acc[lang].push(voice);
    return acc;
  }, {});
  Object.keys(voicesByLang).sort().forEach(lang => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = lang;
    voicesByLang[lang].forEach(voice => {
      const option = document.createElement('option');
      option.value = voice.name;
      option.textContent = voice.name;
      optgroup.appendChild(option);
    });
    voiceSelect.appendChild(optgroup);
  });
  updateVoiceSelection(); 
}

function updateVoiceSelection() {
  const nar = narradorSelect.value;
  const preferredVoiceName = voiceMapping[nar] || '';
  let foundVoice = false;
  for (let i = 0; i < voiceSelect.options.length; i++) {
    if (voiceSelect.options[i].value === preferredVoiceName) {
      voiceSelect.selectedIndex = i;
      foundVoice = true;
      break;
    }
  }
  if (!foundVoice && voiceSelect.options[0] && voiceSelect.options[0].value === "") {
    voiceSelect.selectedIndex = 0; 
  }
}

const voiceSettings = {
  "Cronista portugu√™s": { langPref: 'pt-PT', rate: 0.9, pitch: 1.0 },
  "Ind√≠gena": { langPref: 'pt-BR', rate: 1.0, pitch: 1.15 },
  "Africano escravizado": { langPref: 'pt-BR', rate: 1.05, pitch: 0.95 },
  "Estudante": { langPref: 'pt-BR', rate: 1.0, pitch: 1.0 }
};

function normalize(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function hashString(str){ let h=0; for(let i=0;i<str.length;i++){ h = ((h<<5)-h) + str.charCodeAt(i); h |= 0; } return h; }

function pickVoiceForNarrator(narrator){
  const selectedVoiceName = voiceSelect.value;
  if (selectedVoiceName) {
    const selectedVoice = voices.find(v => v.name === selectedVoiceName);
    if (selectedVoice) return selectedVoice;
  }
  const vs = voiceSettings[narrator] || {langPref:'pt-BR', rate:1, pitch:1};
  if (!voices || voices.length===0) return null;
  const pref = (vs.langPref || '').toLowerCase();
  let voice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(pref));
  if (!voice) voice = voices.find(v => v.lang && v.lang.toLowerCase().includes(pref.split('-')[0]));
  if (!voice) {
    const ptVoices = voices.filter(v => v.lang && v.lang.toLowerCase().includes('pt'));
    if (ptVoices.length>0) {
      const idx = Math.abs(hashString(narrator)) % ptVoices.length;
      voice = ptVoices[idx];
    }
  }
  if (!voice) voice = voices[0];
  return voice;
}

function speakText(text, lang='pt-BR', narrator='Estudante', opts = {}){
  speechSynthesis.cancel();
  if (!text || !text.trim()) return;
  const settings = voiceSettings[narrator] || {langPref:'pt-BR', rate:1, pitch:1};
  const chosen = pickVoiceForNarrator(narrator) || null; 
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang || 'pt-BR';
  if (chosen) u.voice = chosen;
  u.rate = opts.rate !== undefined ? opts.rate : settings.rate;
  u.pitch = opts.pitch !== undefined ? opts.pitch : settings.pitch;
  u.volume = opts.volume !== undefined ? opts.volume : 1.0;
  speechSynthesis.speak(u);
}

// ===================== Reproduzir √°udio ===================== /
let currentAudio = null;
function stopAllAudio(){
  try { speechSynthesis.cancel(); } catch(e){}
  if (currentAudio) { try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){} currentAudio = null; }
}

function getAudioPathFor(ev, nar) {
  const obj = audioMapping[ev] || {};
  if (obj[nar]) return obj[nar];
  const normNar = normalize(nar);
  for (const k of Object.keys(obj)) {
    if (normalize(k) === normNar) return obj[k];
  }
  for (const k of Object.keys(obj)) {
    if (normalize(k).includes(normNar.split(' ')[0]) || normNar.includes(normalize(k).split(' ')[0])) return obj[k];
  }
  return null;
}

playAudioBtn.addEventListener('click', ()=>{
  const ev = eventoSelect.value; const nar = narradorSelect.value;
  if (!ev || !nar) { updateRecordingStatus('‚ùå Selecione evento e narrador antes de reproduzir'); return; }
  stopAllAudio();
  if (nar === "Estudante" && hasRecordingForCurrentEvent()) {
    const url = getRecordingForCurrentEvent();
    currentAudio = new Audio(url);
    currentAudio.play().catch(e=>{
      console.error('Erro reprodu√ß√£o local:', e);
      speakText(data[ev].narrativas[nar]||'', 'pt-BR', nar);
    });
    return;
  }
  const audioPath = getAudioPathFor(ev, nar);
  if (audioPath) {
    currentAudio = new Audio(audioPath);
    currentAudio.play().catch(err=>{
      console.warn('Erro ao reproduzir arquivo (fallback TTS):', err);
      currentAudio = null;
      speakText(data[ev].narrativas[nar]||'', 'pt-BR', nar); 
    });
  } else {
    speakText(data[ev].narrativas[nar]||'', 'pt-BR', nar);
  }
});
stopAudioBtn.addEventListener('click', ()=> {
  stopAllAudio();
});

// ===================== Recording ===================== /
let mediaRecorder = null; let audioChunks = []; let audioStream = null;
function updateRecordingStatus(message,type=''){ recordingStatus.textContent = message; recordingStatus.className = 'recording-status'; if (type) recordingStatus.classList.add(type); }
function hasRecordingForCurrentEvent() { const ev = eventoSelect.value || ''; const eventKey = `recording_${ev.replace(/\s+/g,'_')}`; return localStorage.getItem(eventKey) !== null; }
function getRecordingForCurrentEvent() { const ev = eventoSelect.value || ''; const eventKey = `recording_${ev.replace(/\s+/g,'_')}`; const saved = localStorage.getItem(eventKey); if (saved) { const arr = new Uint8Array(JSON.parse(saved)); const blob = new Blob([arr], {type:'audio/webm'}); return URL.createObjectURL(blob); } return null; }
function saveRecording(blob) { const reader = new FileReader(); reader.onload = function(){ const arrayBuffer = this.result; const uint8 = new Uint8Array(arrayBuffer); const ev = eventoSelect.value || ''; const key = `recording_${ev.replace(/\s+/g,'_')}`; localStorage.setItem(key, JSON.stringify(Array.from(uint8))); updateRecordingStatus('‚úÖ Grava√ß√£o salva com sucesso!','recording-saved'); recPlayBtn.disabled=false; recDeleteBtn.disabled=false; if (narradorSelect.value === "Estudante") narrativeText.textContent = "üé§ Narrativa em √°udio dispon√≠vel - clique em 'Reproduzir Grava√ß√£o' para ouvir."; }; reader.readAsArrayBuffer(blob); }
function deleteRecording() { const ev = eventoSelect.value || ''; const key = `recording_${ev.replace(/\s+/g,'_')}`; localStorage.removeItem(key); updateRecordingStatus('Grava√ß√£o exclu√≠da'); recPlayBtn.disabled=true; recDeleteBtn.disabled=true; if (narradorSelect.value === "Estudante") narrativeText.textContent = data[ev].narrativas["Estudante"] || ""; }
async function initializeRecording(){ try{ if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error('Sem suporte'); checkSavedRecording(); } catch(e){ console.error(e); recStartBtn.disabled=true; updateRecordingStatus('‚ùå Grava√ß√£o n√£o suportada neste navegador'); } }
function checkSavedRecording(){ if (hasRecordingForCurrentEvent()) { recPlayBtn.disabled=false; recDeleteBtn.disabled=false; updateRecordingStatus('Grava√ß√£o dispon√≠vel para este evento'); } else { recPlayBtn.disabled=true; recDeleteBtn.disabled=true; updateRecordingStatus('Nenhuma grava√ß√£o salva para este evento'); } }

recStartBtn.addEventListener('click', async ()=> {
  if (!eventoSelect.value) { updateRecordingStatus('‚ùå Selecione um evento primeiro'); return; }
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, sampleRate:44100 }});
    mediaRecorder = new MediaRecorder(audioStream, { mimeType:'audio/webm;codecs=opus' });
    audioChunks = [];
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => { const blob = new Blob(audioChunks, { type:'audio/webm' }); saveRecording(blob); if (audioStream){ audioStream.getTracks().forEach(t=>t.stop()); audioStream=null; } };
    mediaRecorder.onerror = ev => { console.error('Erro grava√ß√£o', ev); updateRecordingStatus('‚ùå Erro na grava√ß√£o'); };
    mediaRecorder.start();
    recStartBtn.disabled=true; recStopBtn.disabled=false; recPlayBtn.disabled=true;
    updateRecordingStatus('üî¥ Gravando...', 'recording-active');
  } catch(e) {
    console.error('Erro acesso microfone', e);
    updateRecordingStatus('‚ùå N√£o foi poss√≠vel acessar o microfone');
    recStartBtn.disabled=true;
  }
});
recStopBtn.addEventListener('click', ()=> { if (mediaRecorder && mediaRecorder.state === 'recording'){ mediaRecorder.stop(); recStartBtn.disabled=false; recStopBtn.disabled=true; } });
recPlayBtn.addEventListener('click', ()=> {
  const url = getRecordingForCurrentEvent(); if (url) { if (currentAudio) { try{currentAudio.pause(); currentAudio.currentTime=0;}catch(e){} } speechSynthesis.cancel(); currentAudio = new Audio(url); currentAudio.play().catch(e=>{ console.error('Erro reproduzir grava√ß√£o', e); updateRecordingStatus('‚ùå Erro ao reproduzir grava√ß√£o'); }); }
});
recDeleteBtn.addEventListener('click', deleteRecording);
eventoSelect.addEventListener('change', ()=> { checkSavedRecording(); });
initializeRecording();
</script>
</body>
</html>
